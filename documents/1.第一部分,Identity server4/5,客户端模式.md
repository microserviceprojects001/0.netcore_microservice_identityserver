# å…ˆäº†è§£ä¸€ä¸‹æœ€åä¸€ä¸ªæ¨¡å¼ï¼Œå®¢æˆ·ç«¯æ¨¡å¼ï¼Œå¸®æˆ‘ä»‹ç»ä¸€ä¸‹åŸç†å’Œæµç¨‹

ğŸ“Œ å®¢æˆ·ç«¯æ¨¡å¼ï¼ˆClient Credentials Grantï¼‰
å®¢æˆ·ç«¯æ¨¡å¼æ˜¯ OAuth 2.0 çš„ å››ç§æˆæƒæ¨¡å¼ ä¹‹ä¸€ï¼Œé€‚ç”¨äºæœºå™¨å¯¹æœºå™¨ï¼ˆM2Mï¼‰é€šä¿¡ï¼Œå³ï¼š
âœ… æ²¡æœ‰ç”¨æˆ·å‚ä¸ï¼Œå®¢æˆ·ç«¯è‡ªå·±è®¤è¯è‡ªå·±å¹¶ç›´æ¥è·å–è®¿é—®ä»¤ç‰Œï¼ˆaccess tokenï¼‰ã€‚
âœ… å¸¸ç”¨äºå¾®æœåŠ¡ã€API è°ƒç”¨ã€åå°ä»»åŠ¡ã€æœºå™¨å¯¹æœºå™¨ï¼ˆM2Mï¼‰é€šä¿¡ã€‚

ğŸ“ 1. å®¢æˆ·ç«¯æ¨¡å¼çš„åŸç†

- ä¸æ¶‰åŠç”¨æˆ·èº«ä»½ï¼Œå®¢æˆ·ç«¯ç›´æ¥ä»¥ è‡ªå·±çš„èº«ä»½ è¯·æ±‚è®¿é—®ä»¤ç‰Œã€‚

- é€šè¿‡ client_id å’Œ client_secret é‰´æƒï¼Œè·å¾— access_tokenã€‚

- é€‚ç”¨äºå—ä¿¡ä»»çš„æœåŠ¡ç«¯åº”ç”¨ï¼Œå¦‚ï¼šå¾®æœåŠ¡é—´è°ƒç”¨ã€è‡ªåŠ¨åŒ–ä»»åŠ¡ã€äº‘æœåŠ¡ APIã€‚

ğŸ”„ 2. è®¤è¯æµç¨‹

```
+--------------+                                       +----------------------+
|              |                                       |                      |
|   Client     |                                       |  Authorization Server |
|              |                                       |                      |
+--------------+                                       +----------------------+
       |                                                         |
       |   1. å‘é€å‡­æ® (client_id, client_secret)                |
       |   POST /token?grant_type=client_credentials            |
       |                                                         |
       |-------------------------------------------------------->|
       |                                                         |
       |   2. è¿”å›è®¿é—®ä»¤ç‰Œ (access_token)                        |
       |   { "access_token": "xyz", "token_type": "bearer" }     |
       |<--------------------------------------------------------|
       |                                                         |
       |   3. ä½¿ç”¨ access_token è®¿é—® API                         |
       |   GET /resource HTTP/1.1                                |
       |   Authorization: Bearer xyz                             |
       |-------------------------------------------------------->|
       |                                                         |
       |   4. æœåŠ¡å™¨æ ¡éªŒä»¤ç‰Œå¹¶è¿”å›èµ„æº                           |
       |   { "data": "some protected content" }                  |
       |<--------------------------------------------------------|


```

ğŸ” 3. å…·ä½“æ­¥éª¤
ğŸ”¹ (1) å®¢æˆ·ç«¯è¯·æ±‚è®¿é—®ä»¤ç‰Œ
å®¢æˆ·ç«¯å‘æˆæƒæœåŠ¡å™¨å‘é€ POST è¯·æ±‚ï¼ŒåŒ…å«ï¼š

- grant_type=client_credentials

- client_idï¼ˆå®¢æˆ·ç«¯ IDï¼‰

- client_secretï¼ˆå®¢æˆ·ç«¯å¯†é’¥

```
curl -X POST "https://auth.example.com/oauth/token" \
     -H "Content-Type: application/x-www-form-urlencoded" \
     -d "grant_type=client_credentials&client_id=YOUR_CLIENT_ID&client_secret=YOUR_CLIENT_SECRET"

```

ğŸ”¹ (2) æˆæƒæœåŠ¡å™¨è¿”å› access_token
å¦‚æœ client_id å’Œ client_secret éªŒè¯é€šè¿‡ï¼ŒæˆæƒæœåŠ¡å™¨ä¼šè¿”å› access_tokenï¼š

```
{
  "access_token": "eyJhbGciOiJIUzI1...",
  "token_type": "Bearer",
  "expires_in": 3600
}

```

- access_tokenï¼šä»¤ç‰Œï¼Œç”¨äºè®¿é—®å—ä¿æŠ¤èµ„æºã€‚

- token_typeï¼šé€šå¸¸æ˜¯ "Bearer"ã€‚

- expires_inï¼šä»¤ç‰Œæœ‰æ•ˆæœŸï¼ˆç§’ï¼‰ã€‚

ğŸ”¹ (3) å®¢æˆ·ç«¯ç”¨ access_token è®¿é—® API
å®¢æˆ·ç«¯åœ¨è¯·æ±‚ API æ—¶ï¼Œéœ€è¦åœ¨ Authorization å¤´éƒ¨åŠ ä¸Š access_tokenï¼š

```
curl -X GET "https://api.example.com/resource" \
     -H "Authorization: Bearer eyJhbGciOiJIUzI1..."

```

API æœåŠ¡å™¨éªŒè¯ access_token åï¼Œè¿”å›å—ä¿æŠ¤çš„èµ„æºï¼š

```
{
  "data": "some protected content"
}

```

âœ… 4. å®¢æˆ·ç«¯æ¨¡å¼çš„é€‚ç”¨åœºæ™¯

```
é€‚ç”¨åœºæ™¯	             è¯´æ˜
å¾®æœåŠ¡ä¹‹é—´çš„è®¤è¯	      A å¾®æœåŠ¡è¯·æ±‚ B å¾®æœåŠ¡çš„ APIï¼Œä¸æ¶‰åŠç”¨æˆ·èº«ä»½
æœºå™¨å¯¹æœºå™¨ï¼ˆM2Mï¼‰é€šä¿¡	  æœåŠ¡å™¨ç«¯åº”ç”¨è®¿é—®å¤–éƒ¨ APIï¼Œä¾‹å¦‚ AWSã€GitHub API
è‡ªåŠ¨åŒ–ä»»åŠ¡	              å®šæ—¶ä»»åŠ¡ã€CI/CDã€æ¶ˆæ¯é˜Ÿåˆ—ç­‰æ— éœ€ç”¨æˆ·ç™»å½•çš„ç³»ç»Ÿ
IoT è®¾å¤‡æˆæƒ	         è®¾å¤‡ç›´æ¥ç”¨ client_id å’Œ client_secret è®¤è¯

```

âš ï¸ 5. å®¢æˆ·ç«¯æ¨¡å¼çš„å®‰å…¨æ€§

- å¿…é¡»ä¿è¯ client_secret ä¸èƒ½æ³„éœ²ï¼

  - ä¸èƒ½åœ¨å‰ç«¯å­˜ client_secretï¼Œå¦åˆ™å®¹æ˜“è¢«ç›—å–ã€‚

  - åªèƒ½åœ¨å—ä¿¡ä»»çš„æœåŠ¡å™¨ç«¯åº”ç”¨ä¸­ä½¿ç”¨ã€‚

- åº”ä½¿ç”¨ HTTPS ä¼ è¾“

  - ä¸èƒ½ç”¨ HTTP ä¼ è¾“ client_secretï¼Œå¦åˆ™å®¹æ˜“è¢«ä¸­é—´äººæ”»å‡»ã€‚

- å¯ä½¿ç”¨ JWT ä»¤ç‰Œ

  - ä»¤ç‰Œå¯ä»¥ç”¨ JWTï¼ˆJSON Web Tokenï¼‰ï¼Œè®© API æœåŠ¡å™¨æ— éœ€é¢å¤–æŸ¥è¯¢æ•°æ®åº“æ¥éªŒè¯ access_tokenã€‚

ğŸ’¡ 6. ç»“è®º
ğŸ”¹ å®¢æˆ·ç«¯æ¨¡å¼é€‚ç”¨äºåç«¯æœåŠ¡é—´é€šä¿¡ï¼Œä¸æ¶‰åŠç”¨æˆ·èº«ä»½è®¤è¯ã€‚
ğŸ”¹ å®‰å…¨æ€§ä¾èµ–äº client_secret ä¿æŠ¤ï¼Œå¿…é¡»é¿å…æ³„éœ²ã€‚
ğŸ”¹ é€‚ç”¨äºå¾®æœåŠ¡ã€M2M è®¤è¯ã€è‡ªåŠ¨åŒ–ä»»åŠ¡ç­‰åœºæ™¯ã€‚

# ä¸€äº›ç–‘é—®

## å°±æ˜¯è¯´ å®¢æˆ·ç«¯æ¨¡å¼ è¿™ä¸ªæ–¹å¼ä¸æ˜¯æ‹¿æ¥ ç”¨æˆ·ç™»å½•ç®€ä¹¦ç³»ç»Ÿç”¨çš„è¢«

æ˜¯çš„ï¼Œå®¢æˆ·ç«¯æ¨¡å¼ï¼ˆClient Credentials Grantï¼‰ ä¸æ˜¯ç”¨æ¥è®©ç”¨æˆ·ç™»å½•ç®€ä¹¦çš„ï¼Œè€Œæ˜¯ç”¨äºæœåŠ¡ç«¯ä¹‹é—´çš„èº«ä»½è®¤è¯ã€‚ğŸš€

ğŸš« ä¸ºä»€ä¹ˆå®¢æˆ·ç«¯æ¨¡å¼ä¸é€‚ç”¨äºç”¨æˆ·ç™»å½•ï¼Ÿ

- å®ƒæ˜¯æœåŠ¡å¯¹æœåŠ¡çš„æˆæƒæ–¹å¼ï¼Œä¸æ¶‰åŠç”¨æˆ·èº«ä»½ã€‚

- ç”¨æˆ·æ— æ³•è¾“å…¥ç”¨æˆ·åå¯†ç ï¼Œä¹Ÿä¸ä¼šè¿›è¡Œ OAuth æˆæƒã€‚

- é€‚ç”¨äºåç«¯è®¤è¯ï¼Œä½†ä¸é€‚ç”¨äºç”¨æˆ·è®¤è¯ã€‚

## å®¢æˆ·ç«¯æ¨¡å¼ ï¼Œèƒ½å†å¸®æˆ‘ä¸¾ä¸€äº›å®ä¾‹å—ï¼Œæ¯”æ–¹è¯´ ä½ æåˆ°çš„ ä½ çš„ è®¢å•æœåŠ¡ éœ€è¦è®¿é—® ç”¨æˆ·æœåŠ¡ï¼ŒéªŒè¯è®¢å•å½’å±ï¼Œèƒ½å¸®æˆ‘è¯¦ç»†è¯´æ˜ä¸€ä¸‹è®¤è¯ æµç¨‹å—

ğŸ¢ å¾®æœåŠ¡æ¶æ„ä¸­çš„å®¢æˆ·ç«¯æ¨¡å¼ç¤ºä¾‹
åœºæ™¯ï¼šè®¢å•æœåŠ¡ï¼ˆorder-serviceï¼‰è®¿é—®ç”¨æˆ·æœåŠ¡ï¼ˆuser-serviceï¼‰éªŒè¯è®¢å•å½’å±

åœ¨å¾®æœåŠ¡æ¶æ„ä¸‹ï¼Œè®¢å•æœåŠ¡ éœ€è¦å‘ ç”¨æˆ·æœåŠ¡ æŸ¥è¯¢è®¢å•å½’å±å…³ç³»ã€‚ç”±äºè¿™ä¸¤ä¸ªæœåŠ¡éƒ½æ˜¯åç«¯æœåŠ¡ï¼Œä¸æ¶‰åŠç”¨æˆ·ç™»å½•ï¼Œæ‰€ä»¥é€‚åˆä½¿ç”¨å®¢æˆ·ç«¯æ¨¡å¼ï¼ˆClient Credentials Grantï¼‰ã€‚

ğŸ”‘ è¯¦ç»†è®¤è¯æµç¨‹
ğŸ“Œ è§’è‰²ä»‹ç»
1, è®¤è¯æœåŠ¡å™¨ï¼ˆAuth Serverï¼‰ï¼šè´Ÿè´£é¢å‘ä»¤ç‰Œï¼ˆTokenï¼‰ã€‚

2, è®¢å•æœåŠ¡ï¼ˆorder-serviceï¼Œå®¢æˆ·ç«¯ï¼‰ï¼šéœ€è¦è°ƒç”¨ç”¨æˆ·æœåŠ¡çš„ APIï¼ŒéªŒè¯è®¢å•å½’å±ã€‚

3, ç”¨æˆ·æœåŠ¡ï¼ˆuser-serviceï¼Œèµ„æºæœåŠ¡å™¨ï¼‰ï¼šæä¾›å—ä¿æŠ¤çš„ APIï¼Œåªæœ‰é€šè¿‡è®¤è¯çš„æœåŠ¡æ‰èƒ½è®¿é—®ã€‚
ğŸ›  æ­¥éª¤è§£æ
ğŸ”¹ 1ï¸âƒ£ è®¢å•æœåŠ¡å‘è®¤è¯æœåŠ¡å™¨è¯·æ±‚ä»¤ç‰Œ
è®¢å•æœåŠ¡ éœ€è¦è°ƒç”¨ ç”¨æˆ·æœåŠ¡ï¼Œä½†å®ƒå¿…é¡»å…ˆè·å–ä¸€ä¸ªè®¿é—®ä»¤ç‰Œï¼š

```
POST /oauth/token HTTP/1.1
Host: auth.example.com
Content-Type: application/x-www-form-urlencoded

grant_type=client_credentials
&client_id=order-service
&client_secret=order-secret

```

ğŸ”¹ 2ï¸âƒ£ è®¤è¯æœåŠ¡å™¨éªŒè¯èº«ä»½å¹¶è¿”å›ä»¤ç‰Œ
è®¤è¯æœåŠ¡å™¨æ£€æŸ¥ client_id å’Œ client_secret æ˜¯å¦æ­£ç¡®ï¼Œå¹¶è¿”å›ä»¤ç‰Œï¼š

```
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "Bearer",
  "expires_in": 3600
}

```

ğŸ“Œ ä»¤ç‰Œå†…å®¹ï¼š

- access_tokenï¼šç”¨äºè®¿é—® API çš„ä»¤ç‰Œã€‚

- token_typeï¼šé€šå¸¸æ˜¯ Bearerï¼Œè¡¨ç¤ºä½¿ç”¨ HTTP å¤´éƒ¨æºå¸¦ä»¤ç‰Œã€‚

- expires_inï¼šä»¤ç‰Œçš„æœ‰æ•ˆæœŸï¼ˆç§’ï¼‰ã€‚

ğŸ”¹ 3ï¸âƒ£ è®¢å•æœåŠ¡ä½¿ç”¨ä»¤ç‰Œè®¿é—®ç”¨æˆ·æœåŠ¡ API
è®¢å•æœåŠ¡ ç°åœ¨å¯ä»¥ä½¿ç”¨ è·å–åˆ°çš„ä»¤ç‰Œ æ¥è®¿é—® ç”¨æˆ·æœåŠ¡ï¼ŒæŸ¥è¯¢è®¢å•å½’å±ï¼š

```
GET /api/users/123/orders HTTP/1.1
Host: user-service.example.com
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

```

ğŸ”¹ 4ï¸âƒ£ ç”¨æˆ·æœåŠ¡éªŒè¯ä»¤ç‰Œå¹¶è¿”å›è®¢å•å½’å±ä¿¡æ¯

    - ç”¨æˆ·æœåŠ¡ æ”¶åˆ°è¯·æ±‚åï¼Œå®ƒéœ€è¦éªŒè¯ä»¤ç‰Œæ˜¯å¦æœ‰æ•ˆï¼š

    - å¦‚æœä»¤ç‰Œæœ‰æ•ˆï¼šè¿”å›è®¢å•å½’å±ä¿¡æ¯ã€‚

    - å¦‚æœä»¤ç‰Œæ— æ•ˆï¼šè¿”å› 401 Unauthorizedã€‚

âœ… æˆåŠŸå“åº”ï¼ˆä»¤ç‰Œæœ‰æ•ˆï¼‰ï¼š

```
{
  "user_id": 123,
  "orders": [
    { "order_id": 98765, "status": "completed" }
  ]
}

```

ğŸš« å¤±è´¥å“åº”ï¼ˆä»¤ç‰Œæ— æ•ˆï¼‰ï¼š

```
{
  "error": "unauthorized",
  "message": "Invalid or expired token"
}

```

# é‚£è®¢å•æœåŠ¡ï¼Œå¦‚ä½•çŸ¥é“è¦è·å–å“ªä¸ªç”¨æˆ·çš„ å‘¢ï¼Œè¿™ä¸ªè®¤è¯ï¼Œåªéœ€è¦æä¾› grant_type=client_credentials

&client_id=order-service
&client_secret=order-secret å—ï¼Œæˆ‘æ„Ÿè§‰è®¤è¯ä¸åŒè®¢å•ä¼šæ¶‰åŠé“ä¸åŒçš„ç”¨æˆ·å‘€

ä½ çš„é—®é¢˜å¾ˆå…³é”®ï¼åœ¨å®¢æˆ·ç«¯æ¨¡å¼ï¼ˆClient Credentials Grantï¼‰ä¸‹ï¼Œè®¢å•æœåŠ¡ï¼ˆorder-serviceï¼‰ç¡®å®æ— æ³•ç›´æ¥ä»£è¡¨æŸä¸ªç”¨æˆ·å»è®¿é—®ç”¨æˆ·æœåŠ¡ï¼ˆuser-serviceï¼‰ã€‚å› ä¸ºå®¢æˆ·ç«¯æ¨¡å¼æ²¡æœ‰ç”¨æˆ·èº«ä»½ï¼Œå®ƒåªéªŒè¯äº†è®¢å•æœåŠ¡æœ¬èº«çš„èº«ä»½ã€‚è¿™å°±å¸¦æ¥äº†ä¸€ä¸ªæ ¸å¿ƒé—®é¢˜ï¼š

ğŸ’¡ è®¢å•æœåŠ¡å¦‚ä½•çŸ¥é“è¦æŸ¥è¯¢å“ªä¸ªç”¨æˆ·çš„è®¢å•ï¼Ÿ
ğŸ“Œ æ–¹æ¡ˆ 1ï¼šè®¢å•æœåŠ¡æ¥å—ç”¨æˆ·èº«ä»½ä¿¡æ¯
æµç¨‹
1, å‰ç«¯ç”¨æˆ·ç™»å½•ï¼ˆä½¿ç”¨æˆæƒç æ¨¡å¼è·å– access_tokenï¼‰ã€‚

2, å‰ç«¯è°ƒç”¨è®¢å•æœåŠ¡ï¼Œæºå¸¦ç”¨æˆ·çš„ access_tokenã€‚

3, è®¢å•æœåŠ¡è§£æ access_tokenï¼Œè·å–ç”¨æˆ· IDã€‚

4, è®¢å•æœåŠ¡ä½¿ç”¨è‡ªå·±çš„å®¢æˆ·ç«¯å‡­æ®ï¼ˆclient_credentialsï¼‰å»è°ƒç”¨ç”¨æˆ·æœåŠ¡ API
ğŸ“Œ å…·ä½“å®ç°
âœ… æ­¥éª¤ 1ï¼šå‰ç«¯ç”¨æˆ·ç™»å½•ï¼Œè·å– access_token
âœ… æ­¥éª¤ 2ï¼šå‰ç«¯æºå¸¦ç”¨æˆ· access_token è¯·æ±‚è®¢å•æœåŠ¡
âœ… æ­¥éª¤ 3ï¼šè®¢å•æœåŠ¡è§£æ access_tokenï¼Œè·å– user_id
âœ… æ­¥éª¤ 4ï¼šè®¢å•æœåŠ¡ä½¿ç”¨å®¢æˆ·ç«¯æ¨¡å¼è¯·æ±‚ç”¨æˆ·æœåŠ¡
âœ… è®¢å•æœåŠ¡å¯ä»¥å®‰å…¨åœ°ä»£è¡¨ç”¨æˆ·æŸ¥è¯¢è®¢å•æ•°æ®ï¼

## ä½ çš„æ„æ€æ˜¯è¯´ï¼Œè®¢å•æœåŠ¡èƒ½å¤ŸçŸ¥é“ç”¨æˆ·çš„ ID äº†ï¼Œç„¶åç”¨è¿™ä¸ªç”¨æˆ· ID è¿”å›è®¢å•æ•°æ®

è®¢å•æœåŠ¡è®¿é—®ç”¨æˆ·æœåŠ¡
è®¢å•æœåŠ¡è·å–åˆ°ç”¨æˆ·çš„ ID åï¼Œå°±å¯ä»¥å°†ç”¨æˆ· ID ä½œä¸ºå‚æ•°ï¼Œè°ƒç”¨ ç”¨æˆ·æœåŠ¡ çš„ API æ¥è·å–è¯¥ç”¨æˆ·çš„è®¢å•ä¿¡æ¯ã€‚

ä¾‹å¦‚ï¼Œè®¢å•æœåŠ¡å‘ç”¨æˆ·æœåŠ¡å‘é€è¯·æ±‚ï¼š

```
GET /api/users/123/orders
Host: user-service.jianshu.com
Authorization: Bearer service-access-token  # è®¢å•æœåŠ¡çš„å®¢æˆ·ç«¯å‡­è¯

```

## ä¸€ä¸ªæœåŠ¡åœ¨éªŒè¯ ä»¤ç‰Œæ—¶å€™ï¼Œå¦‚ä½•åŒºåˆ†æ˜¯ç”¨æˆ·ç™»å½•æ—¶å€™çš„ä»¤ç‰Œï¼Œè¿˜æ˜¯æœåŠ¡äºæœåŠ¡ä¹‹é—´çš„ä»¤ç‰Œå‘¢

ä¸€ä¸ªæœåŠ¡åœ¨éªŒè¯ä»¤ç‰Œæ—¶ï¼Œé€šå¸¸é€šè¿‡ ä»¤ç‰Œçš„å†…å®¹ï¼ˆå¦‚ subã€audã€grant_type ç­‰å­—æ®µï¼‰æ¥åŒºåˆ†æ˜¯ç”¨æˆ·ä»¤ç‰Œï¼ˆUser Tokenï¼‰è¿˜æ˜¯æœåŠ¡ä»¤ç‰Œï¼ˆClient Tokenï¼‰ã€‚
