# Openid connect 认证流程

## 方式 1，id token 直接带用户信息

![alt text](<../0.课程截图/第一部分 Identity Server/16，第一部分，open id connect 认证流程.png>)

由于在 net9.0 中遇到解决不掉的问题，所以现在去了 net 5.0 的版本中去学习
C:\Code\netcore_microservice_5.0
但是在这里依然没能解决问题(先不继续解决了)

# 去到了 C:\Code\0.identityserver4-richard_1\0.identityserver4-richard

找到了能够成功的资源

# 基于 0.identityserver4-richard 的配置来修改 此处.net 9.0 的，能够认证成功

1，必须要用 https，这是与网上老师视频不同的关键点了，我的理解

## 方式 2,另一种方式获取用户信息

![alt text](<../0.课程截图/第一部分 Identity Server/16_1，第一部分，open id connect 认证流程.png>)
这个方式实际上

这里涉及到了 openid connect 获取 token 时候是否夹带用户信息的两种方式

1，在 identityserver 中对 client 的设置
AlwaysIncludeUserClaimsInIdToken = true,
这样用户信息就会被存储到 id token 中，返回给第三方

2， 如果不设置 AlwaysIncludeUserClaimsInIdToken = true
需要 client 端显示的设置

```
   //options.GetClaimsFromUserInfoEndpoint = true;

    //由于IdentityServer端设定client时候，AlwaysIncludeUserClaimsInIdToken = true
    // options.ClaimActions.MapJsonKey("Avatar", "Avatar");  // 映射自定义 claim
    // options.ClaimActions.MapJsonKey("sub", "sub");
    // options.ClaimActions.MapJsonKey("preferred_username", "preferred_username");
    // options.ClaimActions.MapUniqueJsonKey("role", "role");  // 映射角色 claim

```

如此设置，就是会需要带 AccessToken 再去请求一次 (需要用 postman 尝试一下，我没做成功，)
代码中现在没有问题，获取 claims 没有问题
https://localhost:5002/connect/userinfo
