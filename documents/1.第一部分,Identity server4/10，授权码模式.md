# è§£ææˆæƒç æµç¨‹

![alt text](<../0.è¯¾ç¨‹æˆªå›¾/ç¬¬ä¸€éƒ¨åˆ† Identity Server/14ï¼Œç¬¬ä¸€éƒ¨åˆ†ï¼Œè®¤è¯ç®€ä»‹.png>)

# æˆæƒç è®¤è¯æµç¨‹

![alt text](<../0.è¯¾ç¨‹æˆªå›¾/ç¬¬ä¸€éƒ¨åˆ† Identity Server/15ï¼Œç¬¬ä¸€éƒ¨åˆ†ï¼Œæˆæƒç è®¤è¯æµç¨‹.png>)

# å¼€å§‹åˆ›å»º æ–°çš„å·¥ç¨‹

C:\Code\netcore_microservice

## é‡åˆ°é—®é¢˜ï¼Œ

è¿™é‡Œè€å¸ˆè§†é¢‘ä¸­çš„å·¥ç¨‹ä»£ç æˆ‘ä»¬æ˜¯æ²¡æœ‰çš„ï¼Œéœ€è¦è‡ªå·±æ„å»ºå‡ºæ¥

## éœ€è¦ä¸€ä¸ªæç®€ä»£ç ç»“æ„å¸¦ model, view, controller çš„

dotnet new install Duende.IdentityServer.Templates

dotnet new list
å…¶ä¸­æœ‰è¾“å‡º
Duende IdentityServer Quickstart UI (UI assets only) isui [C#] Web/IdentityServer

dotnet new mvc -n MvcCookieAuthSample # ç”¨äº†è¿™ä¸ªï¼Œå»ç”Ÿæˆ mvc åŸºæœ¬ä»£ç ç»“æ„

å¯¹ MvcCookieAuthSample å·¥ç¨‹è¿›è¡Œä¸€äº›ä¿®æ”¹ï¼ŒåŒ…æ‹¬ IdentityServer åŸºæœ¬é…ç½®ï¼Œä»¥åŠ èƒ½å¤Ÿ Debug ä»£ç çš„å…³é”®é…ç½®
èƒ½å¤Ÿ debug ä»£ç çš„ä¸»è¦æ·»åŠ æ˜¯ launch.json å’Œ tasks.json çš„é…ç½®

## éœ€è¦ä¸€ä¸ªæç®€ä»£ç ç»“æ„å¸¦ model, view, controller çš„ mvc client

dotnet new mvc -n MvcClient
dotnet add package Microsoft.AspNetCore.Authentication.OpenIdConnect

#

æˆ‘æƒ³ç†è§£ä¸€ä¸‹ï¼Œæˆ‘ä»¥å‰çš„ Client é›†æˆ IdentityServer è®¤è¯ï¼Œ

```
builder.Services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)
    .AddJwtBearer(options =>
    {
        options.Authority = "http://localhost:5002";
        //options.requirehttpsmetadata = false;
        options.Audience = "mvc";
        // æ‰‹åŠ¨é…ç½® MetadataAddressï¼Œç»•è¿‡ HTTPS æ£€æŸ¥ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼ï¼‰
        options.ConfigurationManager = new ConfigurationManager<OpenIdConnectConfiguration>(
            metadataAddress: "http://localhost:5002/.well-known/openid-configuration",
            configRetriever: new OpenIdConnectConfigurationRetriever(),
            docRetriever: new HttpDocumentRetriever { RequireHttps = false } // å…³é”®è®¾ç½®
        );
        options.TokenValidationParameters = new()
        {

            ValidateIssuer = false,  // å…è®¸ HTTP å¼€å‘ç¯å¢ƒ
            ValidateIssuerSigningKey = true,
            ValidateLifetime = true,
            ValidateAudience = true
        };
    });

```

å’Œæˆ‘ç°åœ¨è¦åŠ çš„è®¤è¯

```

    builder.Services.AddAuthentication(options =>
{
    options.DefaultScheme = CookieAuthenticationDefaults.AuthenticationScheme;
    options.DefaultChallengeScheme = OpenIdConnectDefaults.AuthenticationScheme;
})
.AddCookie("Cookies", options =>
{
    options.Cookie.Name = "Cookies";
    options.ExpireTimeSpan = TimeSpan.FromHours(1);
})
.AddOpenIdConnect("OpenIdConnect", options =>
{
    options.SignInScheme = "Cookies"; // ä½¿ç”¨ Cookie è¿›è¡Œç™»å½•
    options.Authority = "http://localhost:5002"; // HTTPåœ°å€
    options.ClientId = "mvc";
    options.ClientSecret = "secret";
    //options.ResponseType = "code";
    options.SaveTokens = true;

    // å…³é—­HTTPSéªŒè¯ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼ï¼‰
    options.RequireHttpsMetadata = false; // å…³é”®è®¾ç½®
    options.BackchannelHttpHandler = new HttpClientHandler
    {
        ServerCertificateCustomValidationCallback = HttpClientHandler.DangerousAcceptAnyServerCertificateValidator
    };

    // å…¶ä»–é…ç½®
    options.TokenValidationParameters = new()
    {
        ValidateIssuer = false, // å¼€å‘ç¯å¢ƒå¯å…³é—­IssueréªŒè¯
        ValidateAudience = true
    };
});

```

æœ‰ä»€ä¹ˆä¸åŒå—ï¼Œæˆ‘ä¸å¤ªç†è§£?

ä½ æåˆ°çš„ä¸¤ç§è®¤è¯æ–¹å¼ï¼ˆJwtBearer å’Œ OpenIdConnectï¼‰æ˜¯ .NET ä¸­ä¸¤ç§å®Œå…¨ä¸åŒçš„è®¤è¯æ¨¡å¼ï¼Œé€‚ç”¨äºä¸åŒåœºæ™¯ã€‚ä»¥ä¸‹æ˜¯å®ƒä»¬çš„æ ¸å¿ƒåŒºåˆ«å’Œé€‚ç”¨åœºæ™¯åˆ†æï¼š
ğŸ” æœ¬è´¨åŒºåˆ«

```
ç‰¹æ€§	   JwtBearer è®¤è¯                	 OpenIdConnect è®¤è¯
åè®®	   çº¯ JWT æ ¡éªŒï¼ˆé€šå¸¸ç”¨äº APIï¼‰	      OIDC åè®®ï¼ˆå¸¦å®Œæ•´èº«ä»½è®¤è¯æµç¨‹ï¼‰
äº¤äº’æ–¹å¼	æ— ç•Œé¢è·³è½¬ï¼Œç›´æ¥æ ¡éªŒä»¤ç‰Œ	       ä¼šè·³è½¬åˆ° IdentityServer ç™»å½•é¡µ
å…¸å‹ç”¨é€”	WebAPI/æœåŠ¡é—´é€šä¿¡	              MVC/Razor Pages ç­‰æœ‰å‰ç«¯é¡µé¢çš„åº”ç”¨
ä»¤ç‰Œå¤„ç†	 åªéªŒè¯æ”¶åˆ°çš„ Access Token	     è‡ªåŠ¨å¤„ç† Code æ¢ Token çš„å…¨æµç¨‹
Session ç®¡ç†	æ— çŠ¶æ€	                      é€šè¿‡ Cookie ç»´æŠ¤ä¼šè¯

```

ğŸ› ï¸ ä½ çš„é…ç½®å¯¹æ¯”åˆ†æ

1. æ—§æ–¹æ¡ˆ (JwtBearer)

```
builder.Services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)
    .AddJwtBearer(options => { /* é…ç½® */ });
```

- ç”¨é€”ï¼š
  é€‚åˆçº¯ API é¡¹ç›®ï¼Œç›´æ¥éªŒè¯è¯·æ±‚å¤´ä¸­çš„ Bearer Tokenã€‚

- ç‰¹ç‚¹ï¼š

ä¸ä¼šè‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µ

éœ€è¦æ‰‹åŠ¨è·å– Tokenï¼ˆå¦‚é€šè¿‡ /connect/token ç«¯ç‚¹ï¼‰

æ—  Cookie ä¼šè¯ç®¡ç†

2. æ–°æ–¹æ¡ˆ (OpenIdConnect)

```
builder.Services.AddAuthentication(CookieAuthenticationDefaults.AuthenticationScheme)
    .AddCookie()
    .AddOpenIdConnect(options => { /* é…ç½® */ });
```

- ç”¨é€”ï¼š
  é€‚åˆéœ€è¦ç”¨æˆ·äº¤äº’çš„ MVC/Razor åº”ç”¨ã€‚

- ç‰¹ç‚¹ï¼š

è‡ªåŠ¨è·³è½¬åˆ° IdentityServer ç™»å½•é¡µ

è‡ªåŠ¨å®Œæˆæˆæƒç ï¼ˆCodeï¼‰æ¢ Token çš„æµç¨‹

ä½¿ç”¨ Cookie ç»´æŒç™»å½•çŠ¶æ€

æ”¯æŒè‡ªåŠ¨åˆ·æ–° Token
