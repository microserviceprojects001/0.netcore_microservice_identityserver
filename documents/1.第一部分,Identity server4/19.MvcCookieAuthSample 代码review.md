1. 安装必要的 NuGet 包
   在 IdentityServer 项目中执行以下命令：

```
dotnet add package IdentityServer4.EntityFramework
dotnet add package Pomelo.EntityFrameworkCore.MySql --version 3.2.7
dotnet add package Microsoft.EntityFrameworkCore.Tools

```

# 重新研究D:\Code\1.microservice\0_1.netcore_microservice_identityserver\0.netcore_microservice_identityserver\MvcCookieAuthSample

把数据库文件，快照，以及迁移文件都删除掉后，重新生成数据库

# 添加迁移（明确指定上下文）

```
dotnet ef migrations add YourMigrationName -c ApplicationDbContext

dotnet ef database update -c ApplicationDbContext
```

会生成表：
AspNetUsers

AspNetRoles

AspNetUserRoles

AspNetUserClaims

AspNetUserLogins

AspNetUserTokens

# 然后执行

```
dotnet ef migrations add InitConfigDb -c PersistedGrantDbContext
dotnet ef migrations add InitPersistedGrantDb -c ConfigurationDbContext

dotnet ef database update --context PersistedGrantDbContext
dotnet ef database update --context ConfigurationDbContext
```

生成的表（默认名称）：

Clients：存储客户端应用信息（ClientId、允许的 Scope、重定向 URI 等）。

ClientSecrets：客户端的密钥。

ClientScopes、ClientGrantTypes、ClientRedirectUris 等关联表。

ApiResources：API 资源。

ApiScopes：API 作用域。

IdentityResources：身份资源（OpenID Connect 标准声明）。

以及相关的关联表（如 ApiResourceScopes、IdentityResourceClaims 等）。

这些表用于存储你在 Config.cs 中定义的静态配置数据。

PersistedGrantDbContext（操作存储）
生成的表：

PersistedGrants：存储授权码、刷新令牌、用户同意记录等动态数据。

DeviceCodes：设备流授权所需的设备码。

# 配置文件加载问题

```
var builder = WebApplication.CreateBuilder(args);
var connectionString1 = builder.Configuration.GetConnectionString("MySQL");
foreach (var kvp in builder.Configuration.AsEnumerable())
```

无论如何都不能加载配置

# 通过输出

```
foreach (var kvp in builder.Configuration.AsEnumerable())
{
    Console.WriteLine($"{kvp.Key}: {kvp.Value}");
}
```

查到
contentRoot: D:\Code\1.microservice\2.netcore_microservice_userService\Contact.API  
和contentRoot: D:\Code\1.microservice\0_1.netcore_microservice_identityserver\0.netcore_microservice_identityserverc  
 的确不同呢，

# 方案

launch.json 这个文件中做下修改
"cwd": "${workspaceFolder}", --> "cwd": "${workspaceFolder}/MVCCookieAuthSample",
