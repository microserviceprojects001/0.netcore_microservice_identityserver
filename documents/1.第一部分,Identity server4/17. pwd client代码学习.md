# 理解

projects\IdentityServerSample\PwdClient\Program.cs

在获取用户基本信息的时候

```
 var userInfoResponse = await httpClient.GetUserInfoAsync(new UserInfoRequest
    {
        Address = disco.UserInfoEndpoint,
        Token = passwordTokenResponse.AccessToken
    });
```

如果需要得到用户的 基本信息，需要scope加上 profile
需要得到用户的email，那scope上需要加 email

## 如果你确实需要使用自定义声明（比如 givenName），你需要：

方法 A：扩展 Profile 资源

```
public static IEnumerable<IdentityResource> GetIdentityResources()
{
    return new List<IdentityResource>
    {
        new IdentityResources.OpenId(),

        // 自定义 Profile 资源，包含标准声明和自定义声明
        new IdentityResource(
            name: "profile",
            displayName: "User profile",
            userClaims: new[]
            {
                "name",
                "family_name",
                "given_name",
                "middle_name",
                "nickname",
                "preferred_username",
                "profile",
                "picture",
                "website",
                "gender",
                "birthdate",
                "zoneinfo",
                "locale",
                "updated_at",
                "givenName"  // 添加自定义声明
            })
        {
            Description = "Your user profile information"
        },

        new IdentityResource(
            name: "email",
            displayName: "Your email address",
            userClaims: new[] { "email", "email_verified" })
    };
}
```

方法 B：创建自定义身份资源

```
public static IEnumerable<IdentityResource> GetIdentityResources()
{
    return new List<IdentityResource>
    {
        new IdentityResources.OpenId(),
        new IdentityResources.Profile(),
        new IdentityResources.Email(),

        // 创建自定义身份资源
        new IdentityResource(
            name: "custom",
            displayName: "Custom user information",
            userClaims: new[]
            {
                "givenName",  // 你的自定义声明
                "customField1",
                "customField2"
            })
        {
            Description = "Custom user information"
        }
    };
}
```

然后在客户端配置中添加这个自定义 scope：

```
AllowedScopes = {
    "api",
    "openid",
    "profile",
    "email",
    "custom"  // 添加自定义 scope
}
```

在客户端请求时也包含这个 scope：

```
Scope = "openid api profile email custom"
```

# 对，我就是要问关于ProfileService，通过GetIdentityResources修改和配置等，能够实现自定义的claims支持了，那我需要了解一下ProfileService，如果在Identity Server里定义了类，也是同样可以实现自定义claims添加的哈，

完全正确！ProfileService 是 IdentityServer 中非常强大的一个扩展点，它允许你完全控制返回给客户端的用户声明。与在 GetIdentityResources() 中配置声明相比，ProfileService 提供了更大的灵活性和控制力。

# 在GetIdentityResources设定的和IProfileService都可以实现自定义claims的目的，但是我发现其中还是有些不同呢，GetIdentityResources 需要指定scope才可以得到claims，claims不会被加入到 AccessToken中。如果使用IProfileService我发现claims会被自动加入到 AccessToken中

```
{
  "iss": "http://localhost:5000",
  "nbf": 1770436268,
  "iat": 1770436268,
  "exp": 1770439868,
  "aud": "api",
  "scope": [
    "api",
    "custom",
    "email",
    "openid",
    "profile"
  ],
  "amr": [
    "pwd"
  ],
  "client_id": "pwclient",
  "sub": "1",
  "auth_time": 1770436268,
  "idp": "local",
  "name": "Alice Smith",
  "email": "alice@example.com",
  "website": "https://alice.com",
  "given_name": "Alice11",
  "givenName11": "Alice1111",
  "customField1": "Custom Value 1",
  "customField2": "Custom Value 2",
  "CustomProfileService": "Alice11",
  "jti": "13EBAAFF55C212CE8C60F5AFF681CB4E"
}
```

核心区别分析

1. GetIdentityResources() 方式
   需要显式请求 scope：客户端必须在 token 请求中包含 scope，如 Scope = "custom"

声明通过 UserInfo 端点获取：默认情况下，这些声明不会自动包含在 AccessToken 中

按需获取：更符合最小权限原则

2.  IProfileService 方式
    自动包含在 AccessToken：如果配置正确，声明会自动添加到 AccessToken

无需额外 scope 请求：但通常还是需要关联的 scope

更灵活的控制：可以基于各种条件动态添加声明

# 就是说 控制claims是否进入到 AccessToken，无论是使用什么方式都是可以控制的呗，(没尝试)

# 就是说无论用户名密码认证还是 client认证，API中认证的 audience 需要和AccessToken 中的 aud一致才可以

完全正确！ 这是一个非常关键的认证原理。让我详细解释：
Audience（受众）验证是 JWT 安全的核心

1. 什么是 Audience（aud）？
   aud 声明指定了 令牌的预期接收者

表示这个令牌是给 哪个 API/资源 使用的

API 收到令牌后，会检查 aud 声明是否与自己的标识匹配

2. 三种认证方式的 aud 声明
   Client Credentials 模式

```
{
  "iss": "http://localhost:5000",
  "aud": "api",        // 由 IdentityServer 中的 ApiResource 名称决定
  "scope": "api`",
  "client_id": "client"
}
```

决定因素：ApiResource.Name
Password Credentials 模式

```
{
  "iss": "http://localhost:5000",
  "aud": "api1",        // 同样是 ApiResource 名称
  "scope": "api openid profile",
  "sub": "1",
  "name": "Alice Smith"
}
```

决定因素：ApiResource.Name

3. Client API 中

```
  options.Authority = "http://localhost:5000";
        //options.requirehttpsmetadata = false;
        options.Audience = "api1";
```
